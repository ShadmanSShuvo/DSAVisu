package com.example.demo;

import javafx.application.Application;
import javafx.application.Platform;
import javafx.concurrent.Task;
import javafx.scene.Scene;
import javafx.scene.control.Button;
import javafx.scene.layout.HBox;
import javafx.scene.layout.VBox;
import javafx.scene.paint.Color;
import javafx.scene.shape.Rectangle;
import javafx.scene.text.Text;
import javafx.scene.Group;
import javafx.stage.Stage;

import java.util.ArrayList;
import java.util.Collections;
import java.util.List;

public class SortingAlgorithms extends Application {

    private List<Integer> array = new ArrayList<>();
    private List<Group> bars = new ArrayList<>();
    private VBox root;
    private HBox barContainer;
    private boolean isSorting = false;
    private static final int MAX_HEIGHT = 300;
    private static final int BAR_WIDTH = 20;

    @Override
    public void start(Stage primaryStage) {
        root = new VBox(10);
        barContainer = new HBox(2);
        root.getChildren().add(barContainer);

        Button generateBtn = new Button("Generate");
        Button insertionSortBtn = new Button("Insertion Sort");
        Button mergeSortBtn = new Button("Merge Sort");

        generateBtn.setOnAction(e -> generateArray());
        insertionSortBtn.setOnAction(e -> insertionSort());
        mergeSortBtn.setOnAction(e -> mergeSort());

        HBox buttons = new HBox(10, generateBtn, insertionSortBtn, mergeSortBtn);
        root.getChildren().add(buttons);

        Scene scene = new Scene(root, 1000, 500);
        primaryStage.setScene(scene);
        primaryStage.setTitle("Sorting Visualization");
        primaryStage.show();

        generateArray();
    }

    private void generateArray() {
        if (isSorting)
            return;
        array.clear();
        bars.clear();
        barContainer.getChildren().clear();
        for (int i = 0; i < 30; i++) {
            int value = (int) (Math.random() * MAX_HEIGHT) + 20;
            array.add(value);

            Rectangle bar = new Rectangle(BAR_WIDTH, value);
            bar.setFill(Color.BLUE);
            Text text = new Text(String.valueOf(value));
            text.setFill(Color.BLACK);
            text.setY(-5); // text above the bar

            Group group = new Group(bar, text);
            group.setTranslateY(MAX_HEIGHT - value);
            bars.add(group);
            barContainer.getChildren().add(group);

            // Center label on bar
            bar.widthProperty().addListener((obs, oldVal, newVal) -> {
                text.setX((newVal.doubleValue() - text.getLayoutBounds().getWidth()) / 2);
            });
        }
    }

    private void updateVisualization() {
        Platform.runLater(() -> {
            for (int i = 0; i < array.size(); i++) {
                int value = array.get(i);
                Group group = bars.get(i);
                Rectangle bar = (Rectangle) group.getChildren().get(0);
                Text text = (Text) group.getChildren().get(1);

                bar.setHeight(value);
                group.setTranslateY(MAX_HEIGHT - value);
                text.setText(String.valueOf(value));
                text.setX((BAR_WIDTH - text.getLayoutBounds().getWidth()) / 2);
            }
        });
    }

    private void highlightBars(int i, int j, Color color) {
        Platform.runLater(() -> {
            if (i >= 0 && i < bars.size())
                ((Rectangle) bars.get(i).getChildren().get(0)).setFill(color);
            if (j >= 0 && j < bars.size())
                ((Rectangle) bars.get(j).getChildren().get(0)).setFill(color);
        });
    }

    private void resetBarColors() {
        Platform.runLater(() -> {
            for (Group group : bars) {
                ((Rectangle) group.getChildren().get(0)).setFill(Color.BLUE);
            }
        });
    }

    private void swap(int i, int j) {
        Collections.swap(array, i, j);
        Collections.swap(bars, i, j);
        updateVisualization();
    }

    private void insertionSort() {
        if (isSorting)
            return;
        isSorting = true;
        Task<Void> task = new Task<>() {
            @Override
            protected Void call() throws Exception {
                for (int i = 1; i < array.size(); i++) {
                    int key = array.get(i);
                    Group keyBar = bars.get(i);
                    int j = i - 1;

                    while (j >= 0 && array.get(j) > key) {
                        highlightBars(j, j + 1, Color.YELLOW);
                        array.set(j + 1, array.get(j));
                        bars.set(j + 1, bars.get(j));
                        updateVisualization();
                        Thread.sleep(50);
                        j--;
                    }

                    array.set(j + 1, key);
                    bars.set(j + 1, keyBar);
                    updateVisualization();
                    highlightBars(j + 1, -1, Color.GREEN);
                    Thread.sleep(50);
                }
                resetBarColors();
                return null;
            }
        };
        task.setOnSucceeded(e -> isSorting = false);
        new Thread(task).start();
    }

    private void mergeSort() {
        if (isSorting)
            return;
        isSorting = true;
        Task<Void> task = new Task<>() {
            @Override
            protected Void call() throws Exception {
                mergeSort(0, array.size() - 1);
                resetBarColors();
                return null;
            }
        };
        task.setOnSucceeded(e -> isSorting = false);
        new Thread(task).start();
    }

    private void mergeSort(int left, int right) throws InterruptedException {
        if (left < right) {
            int mid = (left + right) / 2;
            mergeSort(left, mid);
            mergeSort(mid + 1, right);
            merge(left, mid, right);
        }
    }

    private void merge(int left, int mid, int right) throws InterruptedException {
        List<Integer> temp = new ArrayList<>();
        List<Group> tempBars = new ArrayList<>();

        int i = left, j = mid + 1;

        while (i <= mid && j <= right) {
            highlightBars(i, j, Color.YELLOW);
            if (array.get(i) <= array.get(j)) {
                temp.add(array.get(i));
                tempBars.add(bars.get(i));
                i++;
            } else {
                temp.add(array.get(j));
                tempBars.add(bars.get(j));
                j++;
            }
            updateVisualization();
            Thread.sleep(50);
        }

        while (i <= mid) {
            temp.add(array.get(i));
            tempBars.add(bars.get(i));
            i++;
        }

        while (j <= right) {
            temp.add(array.get(j));
            tempBars.add(bars.get(j));
            j++;
        }

        for (int k = 0; k < temp.size(); k++) {
            array.set(left + k, temp.get(k));
            bars.set(left + k, tempBars.get(k));
            highlightBars(left + k, -1, Color.GREEN);
        }
        updateVisualization();
        Thread.sleep(50);
    }

    public static void main(String[] args) {
        launch(args);
    }
}
